{% extends 'base.html' %}

{% block header %}

{% endblock header %}

{% block content %}


<div class="container">
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-3">
        {% for post in posts_list%}
        <div class="col">
            <div class="card text-white bg-dark border-secondary shadow-sm h-100">
                <div class="card-body">
                    <p class="h5 text-primary">{{post.pk}}) {{post.user}}</p>
                    <p class="small text-muted text-end align-bottom">{{post.posted_at}}</p>
                    <hr />
                    <p>{{post.text}}</p>
                    <div class="good-flame btn btn-danger">
                        <a id="good-a" onclick="api_good('{{post.pk}}')">GOOD {{post.good}}| <span
                                id="good_count_{{post.pk}}"></span></a>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script>
    // ページが読み込まれた時にDBから記事に紐づいた「いいね」の数を取得する
    // window.onload = function () {
    //     document.getElementById("good_count_{{post.pk}}").innerText = "{{ post.good }}"
    // }

    // api_good関数が設定されたaタグがクリックされたら、非同期通信でgoodのカウントを1増やし画面に結果を反映する
    function api_good(pk) {
        // いいねの数を増やす記事idをJavaScriptに渡す処理
        var api_url = "api/good/" + pk;
        var btn = document.getElementById("good_count_" + pk);
        // 非同期通信をするための関数をインタンス化する
        var request = new XMLHttpRequest();
        request.onreadystatechange = function () {
            // 非同期通信が完了したら以下のifが処理される。request.readyState === 4部分が非同期処理完了を意味している
            if (request.readyState === 4 && request.status === 200) {
                var received_data = JSON.parse(request.responseText);
                // 画面にいいねの数を反映する
                btn.innerText = received_data.good;
                // 画面をリロードするまでボタンを押せなくする処理
                document.getElementById("good-a-" + pk).removeAttribute("onclick");
            }
        }
        // サーバーとの通信を実行する処理
        request.open("GET", api_url);
        request.send();
    }

</script>
{% endblock content %}